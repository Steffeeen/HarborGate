services:
  harborgate:
    build:
      context: ..
      dockerfile: src/HarborGate/Dockerfile
    container_name: harborgate-routing-test
    ports:
      - "8080:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Testing
      - HARBORGATE_HTTP_PORT=80
      - HARBORGATE_HTTPS_PORT=443
      - HARBORGATE_LOG_LEVEL=Debug
      - HARBORGATE_ENABLE_HTTPS=false
      - HARBORGATE_OIDC_ENABLED=false
    networks:
      - harborgate-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/_health"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Test service 1 - Basic routing
  test-app-1:
    image: traefik/whoami
    container_name: test-app-1
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=app1.test.local"
      - "harborgate.tls=false"
    networks:
      - harborgate-test

  # Test service 2 - Explicit port
  test-app-2:
    image: traefik/whoami
    container_name: test-app-2
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=app2.test.local"
      - "harborgate.port=80"
      - "harborgate.tls=false"
    networks:
      - harborgate-test

  # Test service 3 - Different port (for multi-port testing)
  test-app-3:
    image: nginx:alpine
    container_name: test-app-3
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=app3.test.local"
      - "harborgate.port=80"
      - "harborgate.tls=false"
    networks:
      - harborgate-test

networks:
  harborgate-test:
    driver: bridge
