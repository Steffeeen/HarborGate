services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak-test
    command: start-dev
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HTTP_PORT=8080
    ports:
      - "8090:8080"
    networks:
      - harborgate-auth-test
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 10s
      timeout: 5s
      retries: 30

  harborgate:
    build:
      context: ..
      dockerfile: src/HarborGate/Dockerfile
    container_name: harborgate-auth-test
    depends_on:
      keycloak:
        condition: service_healthy
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Testing
      - HARBORGATE_ENABLE_HTTPS=false
      - HARBORGATE_LOG_LEVEL=Debug
      - HARBORGATE_OIDC_ENABLED=true
      - HARBORGATE_OIDC_AUTHORITY=http://keycloak:8080/realms/harborgate
      - HARBORGATE_OIDC_CLIENT_ID=harborgate-test
      - HARBORGATE_OIDC_CLIENT_SECRET=test-secret-12345
    networks:
      - harborgate-auth-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/_health"]
      interval: 5s
      timeout: 3s
      retries: 20

  # Public service - no auth required
  test-public-app:
    image: traefik/whoami
    container_name: test-public-app
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=public.auth.test"
      - "harborgate.tls=false"
    networks:
      - harborgate-auth-test

  # Protected service - auth required, any authenticated user
  test-protected-app:
    image: traefik/whoami
    container_name: test-protected-app
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=protected.auth.test"
      - "harborgate.tls=false"
      - "harborgate.auth.enable=true"
    networks:
      - harborgate-auth-test

  # Admin-only service - requires admin role
  test-admin-app:
    image: traefik/whoami
    container_name: test-admin-app
    labels:
      - "harborgate.enable=true"
      - "harborgate.host=admin.auth.test"
      - "harborgate.tls=false"
      - "harborgate.auth.enable=true"
      - "harborgate.auth.roles=admin"
    networks:
      - harborgate-auth-test

networks:
  harborgate-auth-test:
    driver: bridge
